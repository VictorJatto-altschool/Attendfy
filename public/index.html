<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendify - Student Attendance System</title>
  <!-- Favicons: provide multiple rels/sizes with cache-busting for reliability across browsers -->
  <link rel="icon" type="image/png" href="Preloader/20250814_221532.png?v=2" sizes="32x32" />
  <link rel="icon" type="image/png" href="Preloader/20250814_221532.png?v=2" sizes="16x16" />
  <link rel="shortcut icon" type="image/png" href="Preloader/20250814_221532.png?v=2" />
  <link rel="apple-touch-icon" href="Preloader/20250814_221532.png?v=2" />
  <meta name="theme-color" content="#2e7d32" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Optional: Firebase for multi-device sync. Leave as-is to stay local-only. -->
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"
    ></script>
    <script>
      // To enable shared data across devices, fill in your Firebase config below and set enabled: true
      window.firebaseConfig = {
  enabled: true,
  apiKey: "AIzaSyC787YhYTxzs950ny9PFMHW6EPdAymi2fk",
  authDomain: "attendance-b36c9.firebaseapp.com",
  projectId: "attendance-b36c9",
  storageBucket: "attendance-b36c9.firebasestorage.app",
  messagingSenderId: "415536927636",
  appId: "1:415536927636:web:9782401666be5215fbb581",
      };
    </script>
  </head>
  <body>
    <!-- Preloader Overlay -->
    <div id="preloader" aria-busy="true" aria-live="polite">
        <div class="preloader-content">
        <i class="bi bi-mortarboard-fill preloader-icon" aria-hidden="true"></i>
        <div class="preloader-text">Loading Attendify</div>
          <img class="preloader-gif" src="Preloader/20250814_221532.png" alt="Loading indicator" />
        <div class="preloader-sub">Getting things readyâ€¦</div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>
          <i class="bi bi-mortarboard-fill" style="color: rgb(52, 133, 52)"></i>
          ATTENDIFY
        </h1>
        <p>GPS-Based Attendance Tracking & Course Management</p>
      </div>

      <div class="main-nav">
        <button class="nav-btn active" onclick="showSection('student-checkin')">
          Student Check-in
        </button>
        <button class="nav-btn" onclick="showSection('course-rep')">
          Course Rep Access
        </button>
        <button class="nav-btn" onclick="showSection('view-timetable')">
          View Timetable
        </button>
      </div>

      <!-- Student Check-in Section -->
      <div id="student-checkin" class="section active">
        <h2 style="text-align: center;">
          <i class="bi bi-geo-alt-fill" style="color: rgb(41, 133, 41)"></i> Student
          Attendance Check-in
        </h2>

        <!-- Enhanced GPS status display with more detailed information -->
        <div id="gps-status" class="gps-status loading">
          <div class="loading"></div>
          <span>Getting your location...</span>
        </div>
        <div
          id="gps-actions"
          class="button-group"
          style="margin-top: -10px; margin-bottom: 10px"
        >
          <button
            type="button"
            id="enable-gps-btn"
            class="btn btn-secondary btn-small"
          >
            <i class="bi bi-unlock-fill"></i> Enable Location
          </button>
          <button
            type="button"
            id="retry-gps-btn"
            class="btn btn-secondary btn-small"
          >
            <i class="bi bi-arrow-clockwise"></i> Retry Location
          </button>
        </div>
        <div id="network-status" class="alert alert-warning hidden"></div>

        <div id="location-details" class="location-details hidden">
          <h4> <i class="bi bi-geo-alt-fill" style="color: rgb(52, 146, 52)"></i> Your Current Location</h4>
          <div class="location-info">
            <div class="location-item">
              <span class="location-label">Latitude:</span>
              <span id="current-lat">--</span>
            </div>
            <div class="location-item">
              <span class="location-label">Longitude:</span>
              <span id="current-lng">--</span>
            </div>
            <div class="location-item">
              <span class="location-label">Accuracy:</span>
              <span id="current-accuracy">--</span>
            </div>
          </div>
        </div>

        <form id="checkin-form">
          <div class="form-group">
            <label for="student-name">Full Name *</label>
            <input
              type="text"
              id="student-name"
              required
              placeholder="Enter your full name"
              autocomplete="name"
            />
          </div>

          <div class="form-group">
            <label for="matriculation">Matriculation Number *</label>
            <input
              type="text"
              id="matriculation"
              required
              placeholder="e.g., U2021/5570123"
              pattern="U[0-9]{4}/[0-9]{7}"
              title="Format must be UYYYY/NNNNNNN e.g., U2021/5570123"
              autocomplete="off"
            />
            <small class="form-help"
              >Format: UYYYY/NNNNNNN (e.g., U2021/5570123)</small
            >
          </div>

          <div class="form-group">
            <label for="course-select">Select Course *</label>
            <select id="course-select" required>
              <option value="">Choose a course...</option>
            </select>
            <small class="form-help" id="course-location-info"></small>
            <small class="form-help" id="course-window-info"></small>
          </div>

          <button type="submit" class="btn btn-primary" id="checkin-btn">
            <i class="bi bi-patch-check-fill"></i> Mark Attendance
          </button>
          <button
            type="button"
            class="btn btn-secondary hidden"
            id="manual-btn"
            onclick="handleManualAttendance()"
          >
            <i class="bi bi-pen-fill"></i>  Manual Attendance
          </button>
        </form>

        <div id="checkin-message"></div>
      </div>

      <!-- Course Rep Access Section -->
      <div id="course-rep" class="section">
        <div class="course-rep-access">
          <h3>
            <i class="bi bi-key-fill" style="color: rgb(48, 141, 48)"></i> Course
            Representative Access
          </h3>
          <p>
            Enter your authorized email to access course management features
          </p>
          <div class="alert alert-info" style="margin-top:10px;">
            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
              <span><i class="bi bi-shield-lock" style="color: lightgreen;"></i> Course rep verification required: get your verified PIN to enter the dashboard.</span>
              <a class="btn btn-success btn-small" href="https://wa.me/+2349110417005" target="_blank" rel="noopener" style="text-decoration: none;">
                <i class="bi bi-whatsapp"></i> Contact Admin via WhatsApp
              </a>
            </div>
          </div>
        </div>

  <form id="rep-login-form" autocomplete="on" method="post" action="/__rep_login" target="auth_sink">
          <div class="form-group">
            <label for="rep-email">Course Rep Email *</label>
            <input
              type="email"
              id="rep-email"
              name="username"
              autocomplete="username"
              placeholder="e.g., johnDoe30@gmail.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="rep-pin">Rep PIN *</label>
            <input
              type="password"
              id="rep-pin"
              name="password"
              pattern=".{4,32}"
              placeholder="Enter 4-32 character PIN"
              autocomplete="current-password"
              required
            />
            <small class="form-help">Second factor to prevent email-only impersonation.</small>
          </div>

          <button type="submit" class="btn btn-primary">
            Verify Access
          </button>
        </form>

  <!-- Hidden iframe target to help trigger browser password manager save without page navigation -->
  <iframe name="auth_sink" id="auth_sink" style="display:none; width:0; height:0; border:0;" aria-hidden="true"></iframe>

        <div id="rep-dashboard" class="hidden">
          <h3><i class="bi bi-bar-chart-line-fill"></i> Course Rep Dashboard</h3>
          <button id="rep-signout-btn" class="btn btn-secondary btn-small" onclick="repSignOut()" style="float:right; margin-top:-48px;"> <i class="bi bi-box-arrow-right"></i> Sign out</button>

          <div class="dashboard-section">
            <h4><i class="bi bi-person-badge" style="color: lightgreen"></i> Rep Profile & Scope</h4>
            <form id="rep-scope-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="rep-faculty">Faculty *</label>
                  <select id="rep-faculty" required>
                    <option value="">Select Faculty</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Medicine">Medicine</option>
                    <option value="Law">Law</option>
                    <option value="Computing">Computing</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="rep-department">Department *</label>
                  <input type="text" id="rep-department" placeholder="e.g., Computer Science" required />
                </div>
                <div class="form-group">
                  <label for="rep-level">Level *</label>
                  <select id="rep-level" required>
                    <option value="">Select Level</option>
                    <option value="100">100 Level</option>
                    <option value="200">200 Level</option>
                    <option value="300">300 Level</option>
                    <option value="400">400 Level</option>
                    <option value="500">500 Level</option>
                  </select>
                </div>
              </div>
              <div class="button-group">
                <button type="submit" class="btn btn-primary"><i class="bi bi-save2"></i> Save Scope</button>
              </div>
              <small class="form-help" id="rep-scope-hint">Your edits and timetable additions are limited to this faculty/department/level.</small>
            </form>
          </div>

          <div class="dashboard-section">
            <h4>Create Weekly Timetable</h4>
            <form id="timetable-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="faculty">Faculty *</label>
                  <select id="faculty" required>
                    <option value="">Select Faculty</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Medicine">Medicine</option>
                    <option value="Law">Law</option>
                    <option value="Law">Computing</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="department">Department *</label>
                  <input
                    type="text"
                    id="department"
                    required
                    placeholder="e.g., Computer Science"
                  />
                </div>

                <div class="form-group">
                  <label for="level">Level *</label>
                  <select id="level" required>
                    <option value="">Select Level</option>
                    <option value="100">100 Level</option>
                    <option value="200">200 Level</option>
                    <option value="300">300 Level</option>
                    <option value="400">400 Level</option>
                    <option value="500">500 Level</option>
                  </select>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="day">Day *</label>
                  <select id="day" required>
                    <option value="">Select Day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="time-slot">Time Slot *</label>
                  <input
                    type="text"
                    id="time-slot"
                    required
                    placeholder="e.g., 8:00 AM - 10:00 AM"
                  />
                </div>

                <div class="form-group">
                  <label for="course-code">Course Code *</label>
                  <input
                    type="text"
                    id="course-code"
                    required
                    placeholder="e.g., CSC 301"
                  />
                </div>

                <div class="form-group">
                  <label for="venue">Venue *</label>
                  <input
                    type="text"
                    id="venue"
                    required
                    placeholder="e.g., LT 1"
                  />
                </div>
              </div>

              <div class="form-grid-2">
                <div class="form-group">
                  <label for="gps-lat">GPS Latitude *</label>
                  <input
                    type="number"
                    id="gps-lat"
                    step="any"
                    required
                    placeholder="e.g., 6.5244"
                  />
                </div>

                <div class="form-group">
                  <label for="gps-lng">GPS Longitude *</label>
                  <input
                    type="number"
                    id="gps-lng"
                    step="any"
                    required
                    placeholder="e.g., 3.3792"
                  />
                </div>
              </div>
              <div id="gps-input-hint" class="alert alert-warning">
                <i class="bi bi-wifi" style="color: rgb(46, 172, 46)"></i>
                For accurate classroom location, ensure a strong network/GPS
                signal before saving to avoid a wrong location.
              </div>

              <div class="button-group">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-calendar2-check-fill"></i> Add to Timetable
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="getCurrentLocation()"
                >
                  <i class="bi bi-geo-alt-fill" style="color: rgb(245, 248, 245)"></i> Use Current Location
                </button>
              </div>
            </form>
          </div>

          <div class="dashboard-section">
            <h4><i class="bi bi-pencil-square" style="color: lightgreen"></i> Manage Timetable</h4>
            <div class="button-group" style="margin-bottom:10px;">
              <button class="btn btn-danger btn-small" onclick="clearAllTimetables()">
                <i class="bi bi-exclamation-triangle-fill"></i> Clear All Timetables
              </button>
            </div>
            <div id="rep-timetable-list" class="timetable-grid"></div>
          </div>

          <div class="dashboard-section">
            <h4>
              <i class="bi bi-graph-up" style="color: lightgreen"></i> Daily
              Attendance Summary
            </h4>
            <div class="summary-controls">
              <div class="form-group">
                <label for="summary-date">Select Date</label>
                <input type="date" id="summary-date" />
              </div>
              <div class="button-group">
                <button class="btn btn-primary" onclick="generateSummary()">
                  <i class="bi bi-file-earmark-word-fill"></i> Generate Summary
                </button>
                <button class="btn btn-success" onclick="downloadSummary()">
                  <i class="bi bi-file-earmark-arrow-down-fill"></i> Download
                </button>
                <button class="btn btn-secondary" onclick="printSummary()">
                  <i class="bi bi-printer-fill"></i> Print
                </button>
              </div>
            </div>

            <div id="attendance-summary"></div>
          </div>
        </div>
      </div>

      <!-- View Timetable Section -->
      <div id="view-timetable" class="section">
        <h2 style="text-align: center;">
          <i class="bi bi-calendar-week" style="color: lightgreen"></i> Weekly
          Timetable
        </h2>

        <!-- Enhanced filter controls with better UX -->
        <div class="filter-controls">
          <div class="filter-header">
            <h4><i class="bi bi-search"></i> Filter Timetable</h4>
            <button
              class="btn btn-secondary btn-small"
              onclick="clearFilters()"
            >
              <i class="bi bi-x-circle"></i> Clear Filters
            </button>
          </div>

          <div class="filter-grid">
            <div class="form-group">
              <label for="filter-faculty">Faculty</label>
              <select id="filter-faculty" onchange="filterTimetable()">
                <option value="">All Faculties</option>
                <option value="Science">Science</option>
                <option value="Arts">Arts</option>
                <option value="Engineering">Engineering</option>
                <option value="Medicine">Medicine</option>
                <option value="Law">Law</option>
                <option value="Law">Computing</option>
              </select>
            </div>

            <div class="form-group">
              <label for="filter-department">Department</label>
              <input
                type="text"
                id="filter-department"
                placeholder="Enter department"
                oninput="filterTimetable()"
              />
            </div>

            <div class="form-group">
              <label for="filter-level">Level</label>
              <select id="filter-level" onchange="filterTimetable()">
                <option value="">All Levels</option>
                <option value="100">100 Level</option>
                <option value="200">200 Level</option>
                <option value="300">300 Level</option>
                <option value="400">400 Level</option>
                <option value="500">500 Level</option>
              </select>
            </div>
          </div>

          <div id="filter-results" class="filter-results"></div>
        </div>

        <div id="timetable-display" class="timetable-grid"></div>
      </div>
    </div>

    <script src="script.js"></script>
  </body>
</html>
